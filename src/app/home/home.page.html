<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Monitoreo de Cámaras · Reporte</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="exportToPDF()" [disabled]="!records.length">
        <ion-icon name="download-outline" slot="start"></ion-icon>
        Exportar PDF
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-grid class="page" [class.loaded]="filtered.length">
    <!-- CARGA CSV -->
    <ion-row>
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title>1) Cargar archivo CSV</ion-card-title>
            <ion-card-subtitle>
              Usa el CSV oficial del formulario de monitoreo (mismo formato/encabezados).
            </ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="dropzone"
                 (drop)="onDrop($event)"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 [class.dragging]="isDragging">
              <ion-icon name="cloud-upload-outline" class="dz-icon"></ion-icon>
              <h3>Arrastra y suelta tu CSV aquí</h3>
              <p>o <button type="button" class="linklike" (click)="browseFiles()">explóralo en tu equipo</button></p>
              <input #fileInput type="file" accept=".csv" (change)="onFileSelected($event)" hidden />
            </div>

            <ion-text color="medium" *ngIf="!records.length">
              <p class="hint">Aún no hay datos cargados.</p>
            </ion-text>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- FILTROS -->
    <ion-row *ngIf="records.length">
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title>2) Filtros</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-row class="filters">
              <ion-col size="12" size-md="4">
                <ion-item>
                  <ion-label position="stacked">Ubicaciones</ion-label>
                  <ion-select interface="popover" [multiple]="true" placeholder="Todas"
                              [(ngModel)]="filters.ubicaciones" (ionChange)="applyFilters()">
                    <ion-select-option *ngFor="let u of allUbicaciones" [value]="u">{{u}}</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="4">
                <ion-item>
                  <ion-label position="stacked">Rango de fechas</ion-label>
                  <div class="inline-selects">
                    <ion-select placeholder="Desde"
                                [value]="filters.desde"
                                (ionChange)="onDesdeSelect($event)">
                      <ion-select-option *ngFor="let d of fechasDesde" [value]="d">{{ d }}</ion-select-option>
                    </ion-select>
                    <span>—</span>
                    <ion-select placeholder="Hasta"
                                [value]="filters.hasta"
                                (ionChange)="onHastaSelect($event)">
                      <ion-select-option *ngFor="let d of fechasHasta" [value]="d">{{ d }}</ion-select-option>
                    </ion-select>
                  </div>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="4">
                <ion-item>
                  <ion-label position="stacked">Momento</ion-label>
                  <ion-select interface="popover" placeholder="Todos"
                              [(ngModel)]="filters.momento" (ionChange)="applyFilters()">
                    <ion-select-option *ngFor="let m of allMomentos" [value]="m">{{m}}</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- KPIs -->
    <ion-row *ngIf="filtered.length">
      <ion-col size="12" size-md="3" *ngFor="let k of kpis">
        <ion-card class="kpi">
          <ion-card-header>
            <ion-card-subtitle>{{k.label}}</ion-card-subtitle>
            <ion-card-title>{{k.value}}</ion-card-title>
          </ion-card-header>
          <ion-card-content *ngIf="k.sub">{{k.sub}}</ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- CONTENIDO DEL REPORTE (para PDF) -->
    <div id="reportContainer" *ngIf="filtered.length">
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Operatividad por Ubicación</ion-card-title>
              <ion-card-subtitle>Operativas (estimadas) vs Total</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <apx-chart
                [series]="chartBar.series"
                [chart]="chartBar.chart"
                [xaxis]="chartBar.xaxis"
                [plotOptions]="chartBar.plotOptions"
                [dataLabels]="chartBar.dataLabels"
                [tooltip]="chartBar.tooltip"
                [yaxis]="chartBar.yaxis"
                [grid]="chartBar.grid"
                [colors]="chartBar.colors"
                [fill]="chartBar.fill"
                [stroke]="chartBar.stroke">
              </apx-chart>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Estado General</ion-card-title>
              <ion-card-subtitle>Operativas vs No operativas</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <apx-chart
                [series]="chartPie.series"
                [chart]="chartPie.chart"
                [labels]="chartPie.labels"
                [legend]="chartPie.legend"
                [dataLabels]="chartPie.dataLabels"
                [plotOptions]="chartPie.plotOptions"
                [colors]="chartPie.colors">
              </apx-chart>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col size="12">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Detalle de Observaciones</ion-card-title>
              <ion-card-subtitle>Fallas reportadas, cámaras afectadas y evidencias</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <ion-accordion-group>
                <ion-accordion *ngFor="let r of filtered; let i = index" [value]="'row'+i">
                  <ion-item slot="header">
                    <ion-label>
                      <b>{{r.fecha | date:'yyyy-MM-dd'}}</b> · {{r.ubicacion}} — {{r.encargado || r.nombre || '—'}}
                    </ion-label>
                  </ion-item>
                  <div class="row-detail" slot="content">
                    <ion-list>
                      <ion-item><ion-label>Total cámaras</ion-label><ion-note slot="end">{{r.total}}</ion-note></ion-item>
                      <ion-item><ion-label>Operativas (estimadas)</ion-label><ion-note slot="end">{{r.operativas}}</ion-note></ion-item>
                      <ion-item><ion-label>No operativas (estimadas)</ion-label><ion-note slot="end">{{r.noOperativas}}</ion-note></ion-item>
                      <ion-item><ion-label>Momento</ion-label><ion-note slot="end">{{r.momento || '—'}}</ion-note></ion-item>
                      <ion-item><ion-label>Mala calidad / obstrucciones</ion-label><ion-note slot="end">{{r.malaCalidad || '—'}}</ion-note></ion-item>
                      <ion-item><ion-label>Fallas imagen (nº)</ion-label><ion-note slot="end">{{r.fallasImagen}}</ion-note></ion-item>
                      <ion-item><ion-label>Fallos reportados</ion-label><ion-note slot="end">{{r.fallosReportados || '—'}}</ion-note></ion-item>
                      <ion-item><ion-label>Cámaras afectadas / detalle</ion-label><ion-note slot="end">{{r.camarasConFalla || '—'}}</ion-note></ion-item>
                      <ion-item><ion-label>Falla técnica (sistema)</ion-label><ion-note slot="end">{{r.fallaTecnica || 'No'}}</ion-note></ion-item>
                      <ion-item><ion-label>Cortes energía/red</ion-label><ion-note slot="end">{{r.cortes || 'No'}}</ion-note></ion-item>
                      <ion-item><ion-label>Observaciones</ion-label><ion-note slot="end">{{r.observaciones || '—'}}</ion-note></ion-item>
                      <ion-item><ion-label>Recomendaciones</ion-label><ion-note slot="end">{{r.recomendaciones || '—'}}</ion-note></ion-item>
                      <ion-item *ngIf="r.adjuntos">
                        <ion-label>Evidencias</ion-label>
                        <ion-note slot="end"><a [href]="r.adjuntos" target="_blank" rel="noopener">Ver adjuntos</a></ion-note>
                      </ion-item>
                    </ion-list>
                  </div>
                </ion-accordion>
              </ion-accordion-group>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </div>
  </ion-grid>
</ion-content>
