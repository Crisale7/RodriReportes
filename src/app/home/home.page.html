<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Reporte de Monitoreo de Cámaras</ion-title>
    <ion-buttons slot="end">
      <ion-button color="primary" (click)="exportPDF()" [disabled]="!parsed">
        <ion-icon name="download-outline" slot="start"></ion-icon>
        Exportar PDF
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="wrapper" id="reportArea">

    <!-- CARGA DE CSV -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>1) Cargar CSV</ion-card-title>
        <ion-card-subtitle>Formato UTF-8 con comillas y saltos de línea</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <input type="file" accept=".csv,text/csv" (change)="onFileSelected($event)" />
        <ion-note *ngIf="fileName" color="medium" class="ml-2">Archivo: {{ fileName }}</ion-note>
        <ion-chip color="success" *ngIf="parsed" class="ml-2">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <ion-label>CSV cargado</ion-label>
        </ion-chip>
      </ion-card-content>
    </ion-card>

    <!-- FILTROS -->
    <ion-card *ngIf="parsed">
      <ion-card-header>
        <ion-card-title>2) Filtros</ion-card-title>
        <ion-card-subtitle>Restringe lo que quieres mostrar en el informe</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="filters-grid">
          <!-- Fecha DESDE -->
          <ion-item>
            <ion-label position="stacked">Fecha (Desde)</ion-label>
            <ion-select interface="popover"
                        placeholder="Todas"
                        [(ngModel)]="filters.fechaDesde"
                        (ionChange)="onFechaSelectChange()">
              <ion-select-option value="">Todas</ion-select-option>
              <ion-select-option *ngFor="let f of lookups.fechas" [value]="f">
                {{ f }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Fecha HASTA -->
          <ion-item>
            <ion-label position="stacked">Fecha (Hasta)</ion-label>
            <ion-select interface="popover"
                        placeholder="Todas"
                        [(ngModel)]="filters.fechaHasta"
                        (ionChange)="onFechaSelectChange()">
              <ion-select-option value="">Todas</ion-select-option>
              <ion-select-option *ngFor="let f of lookups.fechas" [value]="f">
                {{ f }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Ubicación</ion-label>
            <ion-select interface="popover" [value]="filters.ubicacion" (ionChange)="applyFilters()" [(ngModel)]="filters.ubicacion">
              <ion-select-option value="">Todas</ion-select-option>
              <ion-select-option *ngFor="let u of lookups.ubicaciones" [value]="u">{{u}}</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Encargado</ion-label>
            <ion-select interface="popover" [value]="filters.encargado" (ionChange)="applyFilters()" [(ngModel)]="filters.encargado">
              <ion-select-option value="">Todos</ion-select-option>
              <ion-select-option *ngFor="let e of lookups.encargados" [value]="e">{{e}}</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Momento</ion-label>
            <ion-select interface="popover" [value]="filters.momento" (ionChange)="applyFilters()" [(ngModel)]="filters.momento">
              <ion-select-option value="">Todos</ion-select-option>
              <ion-select-option *ngFor="let m of lookups.momentos" [value]="m">{{m}}</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">¿Operativas hoy?</ion-label>
            <ion-select interface="popover" [value]="filters.operativas" (ionChange)="applyFilters()" [(ngModel)]="filters.operativas">
              <ion-select-option value="">Todas</ion-select-option>
              <ion-select-option *ngFor="let op of lookups.operativas" [value]="op">{{op}}</ion-select-option>
            </ion-select>
          </ion-item>

          <div class="filter-actions">
            <ion-button fill="outline" color="medium" (click)="resetFilters()">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              Limpiar filtros
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- MÉTRICAS (componente) -->
    <app-metricas
      *ngIf="parsed"
      [filtered]="filtered"
      (metricsChange)="onMetricsChange($event)">
    </app-metricas>

    <!-- RESUMEN EN TEXTO (nuevo componente) -->
    <app-resumen
      *ngIf="parsed"
      [periodo]="resumen.periodo"
      [ubicacion]="filters.ubicacion"
      [encargado]="filters.encargado"
      [momento]="filters.momento"
      [operativas]="filters.operativas"
      [totalReportes]="filtered.length"
      [metrics]="metrics"
      [destacados]="resumen.destacados">
    </app-resumen>

    <!-- TABLA DE REGISTROS FILTRADOS -->
    <ion-card *ngIf="parsed">
      <ion-card-header>
        <ion-card-title>5) Registros filtrados</ion-card-title>
        <ion-card-subtitle>Como en Excel, pero solo lo relevante</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Id</th>
                <th>Fecha Reporte</th>
                <th>Hora inicio</th>
                <th>Hora fin</th>
                <th>Ubicación</th>
                <th>Encargado</th>
                <th>Momento</th>
                <th>Totales</th>
                <th>Operativas</th>
                <th>Cámaras con falla (#)</th>
                <th>Fallas técnicas (texto)</th>
                <th>Observaciones</th>
                <th>Recomendación</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of filtered">
                <td>{{ r.id }}</td>
                <td>{{ r.fechaReporte | date:'yyyy-MM-dd' }}</td>
                <td>{{ r.horaInicio }}</td>
                <td>{{ r.horaFin }}</td>
                <td>{{ r.ubicacion }}</td>
                <td>{{ r.encargado }}</td>
                <td>{{ r.momento }}</td>
                <td>{{ r.totalCamaras }}</td>
                <td>{{ r.operativasHoy }}</td>
                <td>{{ r.camsConFalla }}</td>
                <td>{{ r.fallasGenerales || r.fallaTipo || 'Sin Observaciones' }}</td>
                <td>{{ r.observaciones }}</td>
                <td>{{ r.recomendacion }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </ion-card-content>
    </ion-card>

  </div> <!-- /reportArea -->

  <div class="footer-space"></div>
</ion-content>
